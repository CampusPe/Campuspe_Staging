name: Deploy Web to Azure Web App

on:
  push:
    branches: [ main ]
    paths: [ 'apps/web/**' ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json

      - name: Install dependencies
        run: |
          cd apps/web
          npm ci --include=dev

      - name: Build application
        run: |
          cd apps/web
          npm run build

      - name: Create deployment package
        run: |
          cd apps/web
          
          # Create deployment directory
          mkdir -p deploy
          
          # Copy source files for Azure to build
          cp -r components deploy/
          cp -r pages deploy/
          cp -r public deploy/ || mkdir -p deploy/public
          cp -r styles deploy/
          cp -r utils deploy/
          
          # Copy configuration files
          cp package.json deploy/
          cp package-lock.json deploy/
          cp next.config.js deploy/ || echo "module.exports = {}" > deploy/next.config.js
          cp tsconfig.json deploy/ || echo '{"extends": "next/tsconfig.json"}' > deploy/tsconfig.json
          cp postcss.config.js deploy/ || echo "module.exports = {}" > deploy/postcss.config.js
          cp tailwind.config.js deploy/ || echo "module.exports = {}" > deploy/tailwind.config.js
          
          # Create optimized package.json for Azure build
          cat > deploy/package.json << 'EOF'
{
  "name": "campuspe-web",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "dev": "next dev -p 3000",
    "build": "next build",
    "start": "node server.js",
    "lint": "next lint",
    "postinstall": "npm run build"
  },
  "engines": {
    "node": ">=20.0.0",
    "npm": ">=10.0.0"
  },
  "dependencies": {
    "axios": "^1.6.7",
    "lucide-react": "^0.525.0",
    "next": "^14.1.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0"
  },
  "devDependencies": {
    "@types/node": "^20.11.0",
    "@types/react": "^18.2.55",
    "@types/react-dom": "^18.2.19",
    "autoprefixer": "^10.4.17",
    "eslint": "^8.56.0",
    "eslint-config-next": "^14.1.0",
    "postcss": "^8.4.35",
    "tailwindcss": "^3.4.1",
    "typescript": "^5.3.3"
  }
}
EOF
          
          # Create server.js for standalone deployment
          cat > deploy/server.js << 'EOF'
const { createServer } = require('http')
const { parse } = require('url')
const next = require('next')

const dev = false
const hostname = process.env.WEBSITE_HOSTNAME || '0.0.0.0'
const port = process.env.PORT || 3000

console.log('ğŸš€ Starting CampusPe Web App...')
console.log('ğŸ“¦ Node.js version:', process.version)
console.log('ğŸŒ Environment:', process.env.NODE_ENV)
console.log('ğŸ”§ Port:', port)
console.log('ğŸ  Hostname:', hostname)

const app = next({ 
  dev: false,
  hostname, 
  port,
  dir: __dirname
})

const handle = app.getRequestHandler()

app.prepare().then(() => {
  console.log('âœ… Next.js app prepared successfully')
  createServer(async (req, res) => {
    try {
      const parsedUrl = parse(req.url, true)
      await handle(req, res, parsedUrl)
    } catch (err) {
      console.error('âŒ Error handling request:', req.url, err)
      res.statusCode = 500
      res.end('Internal server error')
    }
  }).listen(port, hostname, (err) => {
    if (err) {
      console.error('âŒ Server startup error:', err)
      process.exit(1)
    }
    console.log(`ğŸ‰ Server ready on http://${hostname}:${port}`)
  })
}).catch((err) => {
  console.error('âŒ Error preparing Next.js app:', err)
  process.exit(1)
})
EOF
          
          # Create startup script
          cat > deploy/startup.sh << 'EOF'
#!/bin/bash
echo "ğŸš€ Starting CampusPe Web Application..."
cd /home/site/wwwroot
export NODE_ENV=production
export PORT=${PORT:-3000}
echo "ğŸ“¦ Node.js version: $(node --version)"
echo "ğŸš€ Starting server on port $PORT"
node server.js
EOF
          chmod +x deploy/startup.sh

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'campuspe-web-staging-erd8dvb3ewcjc5g2'
          publish-profile: ${{ secrets.AZURE_WEB_PUBLISH_PROFILE }}
          package: apps/web/deploy
