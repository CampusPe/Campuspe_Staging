#!/bin/bash

echo "ğŸ” Diagnosing 503 Service Unavailable Error"
echo "=========================================="

echo ""
echo "ğŸš¨ CURRENT STATUS: Application deployed but not starting"
echo ""

echo "ğŸ“‹ IMMEDIATE ACTIONS REQUIRED:"
echo ""
echo "1. âš™ï¸  SET ENVIRONMENT VARIABLES IN AZURE PORTAL"
echo "   Go to: https://portal.azure.com"
echo "   Navigate: App Services â†’ campuspe-web-staging â†’ Configuration â†’ Application settings"
echo ""
echo "   ADD THESE 6 VARIABLES:"
echo "   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "   â”‚ PORT = 8080                                                             â”‚"
echo "   â”‚ NODE_ENV = production                                                   â”‚"
echo "   â”‚ NEXT_PUBLIC_API_URL = https://campuspe-api-staging-hmfjgud5c6a7exe9.southindia-01.azurewebsites.net â”‚"
echo "   â”‚ WEBSITES_ENABLE_APP_SERVICE_STORAGE = false                            â”‚"
echo "   â”‚ WEBSITE_RUN_FROM_PACKAGE = 1                                           â”‚"
echo "   â”‚ NEXT_TELEMETRY_DISABLED = 1                                            â”‚"
echo "   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo ""
echo "   âš ï¸  CRITICAL: Click 'SAVE' after adding all variables!"
echo ""

echo "2. ğŸ”„ RESTART THE SERVICE"
echo "   In same Azure Portal page: Overview â†’ Restart button â†’ Confirm"
echo ""

echo "3. ğŸ“Š CHECK AZURE LOGS"
echo "   Azure Portal â†’ campuspe-web-staging â†’ Monitoring â†’ Log stream"
echo "   Watch for startup messages and errors"
echo ""

echo "4. â±ï¸  WAIT FOR STARTUP"
echo "   Allow 2-3 minutes for the service to fully restart"
echo ""

echo "ğŸ“ COMMON 503 ERROR CAUSES:"
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚ âŒ Missing environment variables (80% of cases)                   â”‚"
echo "â”‚ âŒ Application startup script failure                             â”‚"
echo "â”‚ âŒ Port binding issues                                            â”‚"
echo "â”‚ âŒ Node.js process crashed on startup                             â”‚"
echo "â”‚ âŒ Missing dependencies or build artifacts                        â”‚"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo ""

echo "ğŸ§ª TESTING COMMANDS:"
echo ""
echo "Test after fixing:"
echo "curl -I https://campuspe-web-staging-erd8dvb3ewcjc5g2.southindia-01.azurewebsites.net/"
echo ""
echo "Check comprehensive status:"
echo "./comprehensive-test.sh"
echo ""

echo "ğŸ†˜ IF STILL FAILING AFTER ENVIRONMENT VARIABLES:"
echo "1. Check Azure Portal logs for specific error messages"
echo "2. Verify startup.js/startup.sh files exist in deployment"
echo "3. Ensure server-azure.js is properly configured"
echo "4. Check if Next.js build artifacts are present"

